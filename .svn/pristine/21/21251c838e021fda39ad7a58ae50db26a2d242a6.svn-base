using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace Dukyou3
{
    public partial class Form_210 : Form
    {
        string DB_TalbeName_hang = "hang_manage";
        cell_d cc = new cell_d();

        int row_id_position = 0; // grid 기준으로 row_id 위치
        int first_data_row = 1;  // grid 기준으로 첫번째 data가 기록되는 행
        int chk_position = 1;    // grid 기준으로 check box의 위치
        SourceGridControl GridHandle = new SourceGridControl();
        ksgcontrol Ct = new ksgcontrol();

        public Form_210()
        {
            InitializeComponent();
        }

        private void Form_210_Load(object sender, EventArgs e)
        {
            ksgcontrol kk = new ksgcontrol();
            string Mac = kk.GetMacAddr();

            bDelete.Visible = false;

            Screen srn = Screen.PrimaryScreen;
            int Xb = this.Width;  //좌,우
            this.Location = new Point((srn.Bounds.Width - Xb) / 2, 1);  //좌/우,위/아래

            GridHandle.SourceGrideInit(grid1, Config.DB_con1, Config.Ftp_ip1, Config.Ftp_id1, Config.Ftp_pw1);
            Ct.ControlInit(Config.DB_con1, Config.Ftp_ip1, Config.Ftp_id1, Config.Ftp_pw1);

            InitCombo(DB_TalbeName_hang, "class", cbClass);

            SourceGrid.Cells.Controllers.CustomEvents val_c1 = new SourceGrid.Cells.Controllers.CustomEvents();
            val_c1.ValueChanged += new EventHandler(ValueChangedEvent1);
            grid1.Controller.AddController(val_c1);

            string cQuery = "select * from " + DB_TalbeName_hang+" order by class, no";
            Grid_View(cQuery);
        }

        public void InitCombo(string DB_TableName, string DB_Column, ComboBox CB)
        {
            Ct.ComboBoxItemInsert(DB_TableName, DB_Column, CB);
        }

        public void Grid_View(string Query)
        {
            int Rows = 0;

            grid1.Rows.Clear();

            grid1.BorderStyle = BorderStyle.FixedSingle;
            grid1.ColumnsCount = 10;
            grid1.FixedRows = 1;

            grid1.Rows.Insert(0);
            grid1.Rows[0].Height = 26;

            grid1[Rows, 0] = new MyHeader1("row_id");
            grid1.Columns[0].Visible = false;

            grid1[Rows, 1] = new MyHeader1("√");

            grid1[Rows, 2] = new MyHeader1("No");

            grid1[Rows, 3] = new MyHeader1("분류");

            grid1[Rows, 4] = new MyHeader1("코드1");

            grid1[Rows, 5] = new MyHeader1("코드2");

            grid1[Rows, 6] = new MyHeader1("항목");
            grid1[Rows, 7] = new MyHeader1("레벨");
            grid1[Rows, 8] = new MyHeader1("순서");
            grid1[Rows, 9] = new MyHeader1("포장코드");
            
            Rows++;

            var DBConn = new MySqlConnection(Config.DB_con1);
            DBConn.Open();
            var cmd = new MySqlCommand(Query, DBConn);

            var myRead = cmd.ExecuteReader();

            grid1.Columns[1].Width = 20;
            grid1.Columns[2].Width = 30;
            grid1.Columns[3].Width = 70;
            grid1.Columns[4].Width = 70;
            grid1.Columns[5].Width = 70;
            grid1.Columns[6].Width = 200;
            grid1.Columns[7].Width = 50;
            grid1.Columns[8].Width = 50;
            grid1.Columns[9].Width = 70;

            while (myRead.Read())
            {
                grid1.Rows.Insert(Rows);
                grid1.Rows[Rows].Height = 24;

                grid1[Rows, 0] = new SourceGrid.Cells.Cell(myRead["row_id"], typeof(string));
                grid1[Rows, 1] = new SourceGrid.Cells.CheckBox(null, false);

                grid1[Rows, 2] = new SourceGrid.Cells.Cell(Rows.ToString(), typeof(string));
                grid1[Rows, 2].View = cc.int_cell;
                grid1[Rows, 2].Editor = cc.disable_cell;

                grid1[Rows, 3] = new SourceGrid.Cells.Cell(myRead["class"], typeof(string));
                grid1[Rows, 3].View = cc.center_cell;
                grid1[Rows, 3].Editor = cc.disable_cell;

                grid1[Rows, 4] = new SourceGrid.Cells.Cell(myRead["code1"], typeof(string));
                grid1[Rows, 4].View = cc.center_cell;
                grid1[Rows, 4].Editor = cc.disable_cell;

                grid1[Rows, 5] = new SourceGrid.Cells.Cell(myRead["code2"], typeof(string));
                grid1[Rows, 5].View = cc.center_cellr;

                grid1[Rows, 6] = new SourceGrid.Cells.Cell(myRead["hang"], typeof(string));
                grid1[Rows, 6].View = cc.left_cellr;

                grid1[Rows, 7] = new SourceGrid.Cells.Cell(myRead["lv"], typeof(string));
                grid1[Rows, 7].View = cc.center_cellr;

                grid1[Rows, 8] = new SourceGrid.Cells.Cell(myRead["no"], typeof(string));
                grid1[Rows, 8].View = cc.center_cellr;

                grid1[Rows, 9] = new SourceGrid.Cells.Cell(myRead["abc_code"], typeof(string));
                grid1[Rows, 9].View = cc.center_cellr;

                Rows++;
            }

            myRead.Close();
            DBConn.Close();
        }

        private void bAdd_Click(object sender, EventArgs e)
        {
            Form_210a Frm = new Form_210a(this);
            Frm.ShowDialog();

            if (Frm.gClass != "" && Frm.gCode != "")
            {
                string Query = "insert into " + DB_TalbeName_hang + " (class, code1, lv, no, mod_time) values('"+Frm.gClass+"','"+Frm.gCode+"',0,0, now())";
                var DBConn = new MySqlConnection(Config.DB_con1);
                DBConn.Open();
                var cmd = new MySqlCommand(Query, DBConn);

                cmd.ExecuteNonQuery();

                Query = "SELECT LAST_INSERT_ID() dd";
                cmd = new MySqlCommand(Query, DBConn);

                var myRead = cmd.ExecuteReader();
                string row_no = "";
                while (myRead.Read())
                    row_no = myRead["dd"].ToString();

                GridNewLine(row_no, Frm.gCode, Frm.gClass);

                DBConn.Close();
                myRead.Close();
                
                var position = new SourceGrid.Position(grid1.Rows.Count - 1, 3);
                grid1.Selection.Focus(position, true);
            }
        }

        void GridNewLine(string row_no, string GetCode, string GetClass)
        {
            int Rows = grid1.RowsCount;

            grid1.Rows.Insert(Rows);
            grid1.Rows[Rows].Height = 24;

            grid1[Rows, 0] = new SourceGrid.Cells.Cell(row_no, typeof(string));
            grid1[Rows, 1] = new SourceGrid.Cells.CheckBox(null, false);

            grid1[Rows, 2] = new SourceGrid.Cells.Cell(Rows.ToString(), typeof(string));
            grid1[Rows, 2].View = cc.int_cell;
            grid1[Rows, 2].Editor = cc.disable_cell;

            grid1[Rows, 3] = new SourceGrid.Cells.Cell(GetClass, typeof(string));
            grid1[Rows, 3].View = cc.center_cell;

            grid1[Rows, 4] = new SourceGrid.Cells.Cell(GetCode, typeof(string));
            grid1[Rows, 4].View = cc.center_cell;

            grid1[Rows, 5] = new SourceGrid.Cells.Cell("", typeof(string));
            grid1[Rows, 5].View = cc.center_cellr;

            grid1[Rows, 6] = new SourceGrid.Cells.Cell("", typeof(string));
            grid1[Rows, 6].View = cc.left_cellr;

            grid1[Rows, 7] = new SourceGrid.Cells.Cell("0", typeof(string));
            grid1[Rows, 7].View = cc.center_cellr;

            grid1[Rows, 8] = new SourceGrid.Cells.Cell("0", typeof(string));
            grid1[Rows, 8].View = cc.center_cellr;

            grid1[Rows, 9] = new SourceGrid.Cells.Cell("", typeof(string));
            grid1[Rows, 9].View = cc.center_cellr;
        }

        private void bDelete_Click(object sender, EventArgs e)
        {
            GridHandle.ChkDataDelete(DB_TalbeName_hang, first_data_row, row_id_position, chk_position);
        }

        private void ValueChangedEvent1(object sender, EventArgs e)  //Grid1에서 볼륨첸지
        {
            string row_no = grid1[grid1.Selection.ActivePosition.Row, 0].ToString().Trim();
            int cpos = grid1.Selection.ActivePosition.Column;
            int rpos = grid1.Selection.ActivePosition.Row;
            string dat;
            dat = grid1[grid1.Selection.ActivePosition.Row, grid1.Selection.ActivePosition.Column].ToString().Trim();
            //
            string cQuery = "";
            //
            if (cpos.Equals(3))       //
                cQuery = " update " + DB_TalbeName_hang + " set class='" + dat + "', mod_time=now() where row_id='" + row_no + "'";
            else if (cpos.Equals(4))  //
                cQuery = " update " + DB_TalbeName_hang + " set code1='" + dat + "', mod_time=now() where row_id='" + row_no + "'";
            else if (cpos.Equals(5))  //
                cQuery = " update " + DB_TalbeName_hang + " set code2='" + dat + "', mod_time=now() where row_id='" + row_no + "'";
            else if (cpos.Equals(6))  //
                cQuery = " update " + DB_TalbeName_hang + " set hang='" + dat + "', mod_time=now() where row_id='" + row_no + "'";
            else if (cpos.Equals(7))  //
                cQuery = " update " + DB_TalbeName_hang + " set lv='" + dat + "', mod_time=now() where row_id='" + row_no + "'";
            else if (cpos.Equals(8))  //
                cQuery = " update " + DB_TalbeName_hang + " set no='" + dat + "', mod_time=now() where row_id='" + row_no + "'";
            else if (cpos.Equals(9))  //
                cQuery = " update " + DB_TalbeName_hang + " set abc_code='" + dat + "', mod_time=now() where row_id='" + row_no + "'";

                
            
            if (!cQuery.Equals(""))
            {
                
                if (GridHandle.DataUpdate(cQuery) == 1)
                {
                    MessageBox.Show("서버에라 발생으로 수정되지 않았습니다.");
                    return;
                }
                if (cpos.Equals(9))
                {
                    if (grid1[rpos, 3].ToString() == "%분류")
                    {
                        Form_502 fm = new Form_502();
                        fm.hang_chk(); //%분류 항목 추가하면 C_paper_grade도 추가해 주는작업
                    }
                }
            }
        }

        private void bSearch_Click(object sender, EventArgs e)
        {
            string cQuery = "select * from " + DB_TalbeName_hang+" where class = '"+cbClass.Text+"' order by class, no";
            Grid_View(cQuery);
        }

        private void button1_Click(object sender, EventArgs e)
        {
            string cQuery = "select * from " + DB_TalbeName_hang+" order by class, no";
            Grid_View(cQuery);
        }
    }
}
