using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using MySql.Data.MySqlClient;

namespace Dukyou3
{
    public partial class Form_501a : Form
    {
        SourceGridControl GridHandle_bunryu = new SourceGridControl();
        SourceGridControl GridHandle_pgroup = new SourceGridControl();
        SourceGridControl GridHandle_pmake = new SourceGridControl();
        SourceGridControl GridHandle_sgroup = new SourceGridControl();
        SourceGridControl GridHandle_ygroup = new SourceGridControl();
        SourceGridControl GridHandle_puse = new SourceGridControl();
        SourceGridControl GridHandle_jiup = new SourceGridControl();
        string DB_TableName_hang = "hang_manage";
        string DB_TableName_cust_code = "C_hcust_jiup_code";
        string DB_TableName_hcust = "C_hcustomer";
        string DB_TalbeName_scode = "C_paper_size_code";
        string DB_TableName_paper_manage = "C_paper_hcust_manage";
        string DB_TableName_paper = "C_paper";

        string paper_id = "";
        string jiup_code = "";
        int rpos = -1;

        Boolean Chk_sgroup_1 = true;
        Boolean Chk_sgroup_2 = true;
        Boolean Chk_jiup = false;
        public bool last_id = false;  //DB 변동이 일어나면 true 
        bool NewItem = true;   //추가이면 true, 수정이면 false
        DataTable s_dt = new DataTable();
       
        public Form_501a(DataTable s_dt)
        {
            InitializeComponent();
            bModi.Visible = false;
            this.s_dt = s_dt;
        }

        public Form_501a(DataTable s_dt, int rpos)
        {
            InitializeComponent();
            this.s_dt = s_dt;
            this.rpos = rpos;
            this.paper_id = s_dt.Rows[rpos]["row_id"].ToString();
            this.jiup_code = s_dt.Rows[rpos]["sock"].ToString(); //grid[rpos, 16].ToString();
            //
            NewItem = false;
            bAdd.Visible = false;
        }

        private void Form_502a_Load(object sender, EventArgs e)
        {
            this.KeyPreview = true;
            Screen srn = Screen.PrimaryScreen;
            int Xb = this.Width;   //좌,우
            int Yb = this.Height;  //위,아래
            if (this.MdiParent == null)
                this.Location = new Point((srn.Bounds.Width - Xb) / 2, 60);  //좌/우,위/아래
            else
                this.Location = new Point((srn.Bounds.Width - Xb) / 2, 1);  //좌/우,위/아래
            //

            Data_Load();

            GridHandle_bunryu.SourceGrideInit(grid_bunryu, Config.DB_con1);
            GridHandle_pgroup.SourceGrideInit(grid_pgroup, Config.DB_con1);
            GridHandle_pmake.SourceGrideInit(grid_pmake, Config.DB_con1);
            GridHandle_sgroup.SourceGrideInit(grid_sgroup, Config.DB_con1);
            GridHandle_ygroup.SourceGrideInit(grid_ygroup, Config.DB_con1);
            GridHandle_puse.SourceGrideInit(grid_puse, Config.DB_con1);
            GridHandle_jiup.SourceGrideInit(grid_jiup, Config.DB_con1);
        }

        private void Data_Load()
        {
            string cQuery = "";
            if (NewItem)
            {
                cQuery = "select * from " + DB_TableName_hang + " where class = '%분류' order by no";
                Grid_hang_View(grid_bunryu, cQuery, "-1");

                cQuery = "select * from " + DB_TableName_hang + " where class = '종이그룹' order by no";
                Grid_hang_View(grid_pgroup, cQuery, "-1");

                cQuery = "select * from " + DB_TableName_hang + " where class = '제지사' order by no";
                Grid_hang_View(grid_pmake, cQuery, "-1");

                cQuery = "select * from " + DB_TableName_hang + " where class = '종이용도' order by no";
                Grid_group_View(grid_puse, cQuery, "-1", 1);

                cQuery = "select concat(paper_alias,'(',size_alias,')',grain) as hang, base_paper_code as code1, row_id, grain from " + DB_TalbeName_scode;
                cQuery += " where prn_guboon='매엽' order by grain desc, sort_no";
                Grid_sizegroup_View(grid_sgroup, cQuery, "-1", 1);

                cQuery = "select concat(paper_alias,'(',size_alias,')',grain) as hang, base_paper_code as code1, row_id, grain from " + DB_TalbeName_scode;
                cQuery += " where prn_guboon='윤전' order by sort_no";
                Grid_sizegroup_View_a(grid_ygroup, cQuery, "-1", 1);

                cQuery = "select a.hcust_id as row_id, a.code as code1, b.sangho as hang from " + DB_TableName_cust_code + " as a ";
                cQuery += " left outer join " + DB_TableName_hcust + " as b on a.hcust_id = b.row_id order by hang";
                Grid_group_View(grid_jiup, cQuery, "A0", 2);
            
            }
            else
            {
                tbWeight.Text = s_dt.Rows[rpos]["paper_weight"].ToString(); //Mom_grid[rpos, 6].ToString();
                tbPname.Text = s_dt.Rows[rpos]["paper_name"].ToString(); //Mom_grid[rpos, 7].ToString();
                tbColor.Text = s_dt.Rows[rpos]["paper_color"].ToString(); //Mom_grid[rpos, 8].ToString();
                tbThick.Text = s_dt.Rows[rpos]["paper_thick"].ToString(); //Mom_grid[rpos, 12].ToString();
                tbNoticePrice.Text = s_dt.Rows[rpos]["notice_price"].ToString(); //Mom_grid[rpos, 10].ToString();

                if (s_dt.Rows[rpos]["paper_name_code"].ToString() == "125")  //Mom_grid[rpos, 14].ToString()
                {
                    rbJang_125.Checked = true;
                    rbJang_250.Checked = false;
                    rbJang_500.Checked = false;
                    rbJang_none.Checked = false;
                }
                else if (s_dt.Rows[rpos]["paper_name_code"].ToString() == "250")
                {
                    rbJang_125.Checked = false;
                    rbJang_250.Checked = true;
                    rbJang_500.Checked = false;
                    rbJang_none.Checked = false;
                }
                else if (s_dt.Rows[rpos]["paper_name_code"].ToString() == "500")
                {
                    rbJang_125.Checked = false;
                    rbJang_250.Checked = false;
                    rbJang_500.Checked = true;
                    rbJang_none.Checked = false;
                }
                else
                {
                    rbJang_125.Checked = false;
                    rbJang_250.Checked = false;
                    rbJang_500.Checked = false;
                    rbJang_none.Checked = true;
                }

                if (s_dt.Rows[rpos]["sock"].ToString() == "110")  //Mom_grid[rpos, 16].ToString()
                {
                    rbSun_110.Checked = true;
                    rbSun_133.Checked = false;
                    rbSun_175.Checked = false;
                    rbSun_none.Checked = false;
                }
                else if (s_dt.Rows[rpos]["sock"].ToString() == "133")
                {
                    rbSun_110.Checked = false;
                    rbSun_133.Checked = true;
                    rbSun_175.Checked = false;
                    rbSun_none.Checked = false;
                }
                else if (s_dt.Rows[rpos]["sock"].ToString() == "175")
                {
                    rbSun_110.Checked = false;
                    rbSun_133.Checked = false;
                    rbSun_175.Checked = true;
                    rbSun_none.Checked = false;
                }
                else
                {
                    rbSun_110.Checked = false;
                    rbSun_133.Checked = false;
                    rbSun_175.Checked = false;
                    rbSun_none.Checked = true;
                }

                cQuery = "select * from " + DB_TableName_hang + " where class = '%분류' order by no";
                Grid_hang_View(grid_bunryu, cQuery, s_dt.Rows[rpos]["bunryu"].ToString());

                cQuery = "select * from " + DB_TableName_hang + " where class = '종이그룹' order by no";
                Grid_hang_View(grid_pgroup, cQuery, s_dt.Rows[rpos]["pgroup"].ToString());

                cQuery = "select * from " + DB_TableName_hang + " where class = '제지사' order by no";
                Grid_hang_View(grid_pmake, cQuery, s_dt.Rows[rpos]["pmake"].ToString());

                cQuery = "select * from " + DB_TableName_hang + " where class = '종이용도' order by no";
                Grid_group_View(grid_puse, cQuery, s_dt.Rows[rpos]["hang_puse_group"].ToString(), 1);

                cQuery = "select concat(paper_alias,'(',size_alias,')',grain) as hang, base_paper_code as code1, row_id, grain from " + DB_TalbeName_scode;
                cQuery += " where prn_guboon='매엽' order by grain desc, sort_no";
                Grid_sizegroup_View(grid_sgroup, cQuery, s_dt.Rows[rpos]["paper_size_group"].ToString(), 1);

                cQuery = "select concat(paper_alias,'(',size_alias,')',grain) as hang, base_paper_code as code1, row_id, grain from " + DB_TalbeName_scode;
                cQuery += " where prn_guboon='윤전' order by sort_no";
                Grid_sizegroup_View_a(grid_ygroup, cQuery, s_dt.Rows[rpos]["yunjeon_size_group"].ToString(), 1);

                cQuery = "select a.hcust_id as row_id, a.code as code1, b.sangho as hang from " + DB_TableName_cust_code + " as a ";
                cQuery += " left outer join " + DB_TableName_hcust + " as b on a.hcust_id = b.row_id order by hang";
                Grid_group_View(grid_jiup, cQuery, s_dt.Rows[rpos]["code"].ToString(), 3);
            }
        }

        private void Grid_sizegroup_View(SourceGrid.Grid grid, string cQuery, string chk_item_group, int code_len)
        {
            cell_d cc = new cell_d();
            // 
            grid.Rows.Clear();
            grid.BorderStyle = BorderStyle.FixedSingle;
            grid.SelectionMode = SourceGrid.GridSelectionMode.Cell;
            grid.ColumnsCount = 12;
            grid.FixedRows = 1;
            grid.Rows.Insert(0);
            grid.Rows[0].Height = 24;
            //
            grid[0, 0] = new MyHeader1("row_id");
            grid.Columns[0].Visible = false;

            grid[0, 1] = new MyHeader1("√");
            grid[0, 2] = new MyHeader1("No");
            grid[0, 3] = new MyHeader1("항목");
            grid[0, 4] = new MyHeader1("코드");
            grid.Columns[4].Visible = false;
            grid[0, 5] = new MyHeader1("결");
            grid.Columns[5].Visible = false;

            grid[0, 6] = new MyHeader1("row_id");
            grid.Columns[6].Visible = false;

            grid[0, 7] = new MyHeader1("√");
            grid[0, 8] = new MyHeader1("No");
            grid[0, 9] = new MyHeader1("항목");
            grid[0, 10] = new MyHeader1("코드");
            grid.Columns[10].Visible = false;
            grid[0, 11] = new MyHeader1("결");
            grid.Columns[11].Visible = false;

            //
            grid.Columns[1].Width = 22;
            grid.Columns[2].Width = 30;
            grid.Columns[3].Width = 150;

            grid.Columns[7].Width = 22;
            grid.Columns[8].Width = 30;
            grid.Columns[9].Width = 150;
            //
            MySqlConnection DBConn;

            DBConn = new MySqlConnection(Config.DB_con1);
            DBConn.Open();

            var cmd = new MySqlCommand(cQuery, DBConn);
            var myRead = cmd.ExecuteReader();
            // 
            int m = 1;
            int column = 0;
            string grain = "";
            while (myRead.Read())
            {
                if (grain != "" && grain != myRead["grain"].ToString())
                {
                    m = 1;
                    column = 6;
                }

                if (column == 0)
                {
                    grid.Rows.Insert(m);
                    grid.Rows[m].Height = 22;
                }
                if (grid.Rows.Count -1 < m) break;                //
                
                grid[m, column + 0] = new SourceGrid.Cells.Cell(myRead["row_id"], typeof(string));
                if(chk_item_group == "-1")
                    grid[m, column + 1] = new SourceGrid.Cells.CheckBox(null, false);
                else
                    grid[m, column + 1] = new SourceGrid.Cells.CheckBox(null, false);

                grid[m, column + 2] = new SourceGrid.Cells.Cell(m.ToString(), typeof(string));
                grid[m, column + 2].View = cc.center_cell;
                grid[m, column + 2].Editor = cc.disable_cell;

                grid[m, column + 3] = new SourceGrid.Cells.Cell(myRead["hang"], typeof(string));
                grid[m, column + 3].View = cc.center_cell;
                grid[m, column + 3].Editor = cc.disable_cell;

                grid[m, column + 4] = new SourceGrid.Cells.Cell(myRead["code1"], typeof(string));
                grid[m, column + 5] = new SourceGrid.Cells.Cell(myRead["grain"], typeof(string));

                grain = myRead["grain"].ToString();
                m++;
            }

            string code = "";
            if (chk_item_group != "-1")
            {
                for (int y = 0; y <= chk_item_group.Length - code_len; y++)
                {
                    code = chk_item_group.Substring(y, code_len);
                    if (code != "#")  // 코드 구분자이면 pass
                    {
                        for (int i = 1; i < grid.RowsCount; i++)
                        {
                            if (grid[i, 4].ToString() == code)
                            {
                                grid[i, 1] = new SourceGrid.Cells.CheckBox(null, true);
                                break;
                            }

                            if (grid[i, 10].ToString() == code)
                            {
                                grid[i, 7] = new SourceGrid.Cells.CheckBox(null, true);
                                break;
                            }
                        }
                    }
                }
            }
            myRead.Close();
            DBConn.Close();
        }

        private void Grid_sizegroup_View_a(SourceGrid.Grid grid, string cQuery, string chk_item_group, int code_len)
        {
            cell_d cc = new cell_d();
            // 
            grid.Rows.Clear();
            grid.BorderStyle = BorderStyle.FixedSingle;
            grid.SelectionMode = SourceGrid.GridSelectionMode.Cell;
            grid.ColumnsCount = 12;
            grid.FixedRows = 1;
            grid.Rows.Insert(0);
            grid.Rows[0].Height = 24;
            //
            grid[0, 0] = new MyHeader1("row_id");
            grid.Columns[0].Visible = false;

            grid[0, 1] = new MyHeader1("√");
            grid[0, 2] = new MyHeader1("No");
            grid[0, 3] = new MyHeader1("항목");
            grid[0, 4] = new MyHeader1("코드");
            grid.Columns[4].Visible = false;
            grid[0, 5] = new MyHeader1("결");
            grid.Columns[5].Visible = false;

            grid[0, 6] = new MyHeader1("row_id");
            grid.Columns[6].Visible = false;

            grid[0, 7] = new MyHeader1("√");
            grid[0, 8] = new MyHeader1("No");
            grid[0, 9] = new MyHeader1("항목");
            grid[0, 10] = new MyHeader1("코드");
            grid.Columns[10].Visible = false;
            grid[0, 11] = new MyHeader1("결");
            grid.Columns[11].Visible = false;

            //
            grid.Columns[1].Width = 22;
            grid.Columns[2].Width = 30;
            grid.Columns[3].Width = 150;

            grid.Columns[7].Width = 22;
            grid.Columns[8].Width = 30;
            grid.Columns[9].Width = 150;
            //
            MySqlConnection DBConn;

            DBConn = new MySqlConnection(Config.DB_con1);
            DBConn.Open();

            var cmd = new MySqlCommand(cQuery, DBConn);
            var myRead = cmd.ExecuteReader();
            // 
            int m = 1;
            int column = 0;
            string grain = "";
            while (myRead.Read())
            {
                grid.Rows.Insert(m);
                grid.Rows[m].Height = 22;
                //
                grid[m, column + 0] = new SourceGrid.Cells.Cell(myRead["row_id"], typeof(string));
                if (chk_item_group == "-1")
                    grid[m, column + 1] = new SourceGrid.Cells.CheckBox(null, false);
                else
                    grid[m, column + 1] = new SourceGrid.Cells.CheckBox(null, false);

                grid[m, column + 2] = new SourceGrid.Cells.Cell(m.ToString(), typeof(string));
                grid[m, column + 2].View = cc.center_cell;
                grid[m, column + 2].Editor = cc.disable_cell;

                grid[m, column + 3] = new SourceGrid.Cells.Cell(myRead["hang"], typeof(string));
                grid[m, column + 3].View = cc.center_cell;
                grid[m, column + 3].Editor = cc.disable_cell;

                grid[m, column + 4] = new SourceGrid.Cells.Cell(myRead["code1"], typeof(string));
                grid[m, column + 5] = new SourceGrid.Cells.Cell(myRead["grain"], typeof(string));

                grain = myRead["grain"].ToString();
                m++;
            }

            string code = "";
            if (chk_item_group != "-1")
            {
                for (int y = 0; y <= chk_item_group.Length - code_len; y++)
                {
                    code = chk_item_group.Substring(y, code_len);
                    if (code != "#")  // 코드 구분자이면 pass
                    {
                        for (int i = 1; i < grid.RowsCount; i++)
                        {
                            if (grid[i, 4].ToString() == code)
                            {
                                grid[i, 1] = new SourceGrid.Cells.CheckBox(null, true);
                                break;
                            }
                        }
                    }
                }
            }
            myRead.Close();
            DBConn.Close();
        }
        
        private void Grid_hang_View(SourceGrid.Grid grid, string cQuery, string chk_item)
        {
            cell_d cc = new cell_d();
            // 
            grid.Rows.Clear();
            grid.BorderStyle = BorderStyle.FixedSingle;
            grid.SelectionMode = SourceGrid.GridSelectionMode.Cell;
            grid.ColumnsCount = 5;
            grid.FixedRows = 1;
            grid.Rows.Insert(0);
            grid.Rows[0].Height = 24;
            //
            grid[0, 0] = new MyHeader1("row_id");
            grid.Columns[0].Visible = false;

            grid[0, 1] = new MyHeader1("√");
            grid[0, 2] = new MyHeader1("No");
            grid[0, 3] = new MyHeader1("항목");
            grid[0, 4] = new MyHeader1("코드");
            grid.Columns[4].Visible = false;

            //
            grid.Columns[1].Width = 22;
            grid.Columns[2].Width = 30;
            if(cQuery.IndexOf("제지사") > 0)  // 제지사는 컬럼을 좀 더 크게
                grid.Columns[3].Width = 100;
            else
                grid.Columns[3].Width = 70;
            //
            MySqlConnection DBConn;

            DBConn = new MySqlConnection(Config.DB_con1);
            DBConn.Open();

            var cmd = new MySqlCommand(cQuery, DBConn);
            var myRead = cmd.ExecuteReader();
            // 
            int m = 1;
            while (myRead.Read())
            {
                grid.Rows.Insert(m);
                grid.Rows[m].Height = 22;
                //
                grid[m, 0] = new SourceGrid.Cells.Cell(myRead["row_id"], typeof(string));

                if(chk_item == myRead["hang"].ToString())
                    grid[m, 1] = new SourceGrid.Cells.CheckBox(null, true);
                else
                    grid[m, 1] = new SourceGrid.Cells.CheckBox(null, false);

                grid[m, 2] = new SourceGrid.Cells.Cell(m.ToString(), typeof(string));
                grid[m, 2].View = cc.center_cell;
                grid[m, 2].Editor = cc.disable_cell;

                grid[m, 3] = new SourceGrid.Cells.Cell(myRead["hang"], typeof(string));
                grid[m, 3].View = cc.center_cell;
                grid[m, 3].Editor = cc.disable_cell;

                grid[m, 4] = new SourceGrid.Cells.Cell(myRead["code1"], typeof(string));
                
                m++;
            }
            myRead.Close();
            DBConn.Close();
        }

        private void Grid_group_View(SourceGrid.Grid grid, string cQuery, string chk_item_group, int code_len)
        {
            cell_d cc = new cell_d();
            // 
            grid.Rows.Clear();
            grid.BorderStyle = BorderStyle.FixedSingle;
            grid.SelectionMode = SourceGrid.GridSelectionMode.Cell;
            grid.ColumnsCount = 5;
            grid.FixedRows = 1;
            grid.Rows.Insert(0);
            grid.Rows[0].Height = 24;
            //
            grid[0, 0] = new MyHeader1("row_id");
            grid.Columns[0].Visible = false;

            grid[0, 1] = new MyHeader1("√");
            grid[0, 2] = new MyHeader1("No");
            grid[0, 3] = new MyHeader1("항목");
            grid[0, 4] = new MyHeader1("코드");
            grid.Columns[4].Visible = false;

            //
            grid.Columns[1].Width = 22;
            grid.Columns[2].Width = 30;
            if(cQuery.IndexOf(DB_TableName_cust_code) > 0) // 지업사 일땐 컬럼을 좀더 크게
                grid.Columns[3].Width = 150;
            else if(cQuery.IndexOf(DB_TalbeName_scode) > 0) // 사이즈그룹 일땐 컬럼을 좀더 크게
                grid.Columns[3].Width = 200;
            else
                grid.Columns[3].Width = 70;
            //
            MySqlConnection DBConn;

            DBConn = new MySqlConnection(Config.DB_con1);
            DBConn.Open();

            var cmd = new MySqlCommand(cQuery, DBConn);
            var myRead = cmd.ExecuteReader();
            // 
            int m = 1;
            while (myRead.Read())
            {
                grid.Rows.Insert(m);
                grid.Rows[m].Height = 22;
                //
                grid[m, 0] = new SourceGrid.Cells.Cell(myRead["row_id"], typeof(string));
                grid[m, 1] = new SourceGrid.Cells.CheckBox(null, false);

                grid[m, 2] = new SourceGrid.Cells.Cell(m.ToString(), typeof(string));
                grid[m, 2].View = cc.center_cell;
                grid[m, 2].Editor = cc.disable_cell;

                grid[m, 3] = new SourceGrid.Cells.Cell(myRead["hang"], typeof(string));
                grid[m, 3].View = cc.center_cell;
                grid[m, 3].Editor = cc.disable_cell;

                grid[m, 4] = new SourceGrid.Cells.Cell(myRead["code1"], typeof(string));

                m++;
            }

            string code = "";
            if (chk_item_group != "-1")
            {
                for (int y = 0; y <= chk_item_group.Length - code_len; y++)
                {
                    code = chk_item_group.Substring(y, code_len);
                    if (code != "#")  // 코드 구분자이면 pass
                    {
                        for (int i = 1; i < grid.RowsCount; i++)
                        {
                            if (grid[i, 4].ToString() == code)
                            {
                                grid[i, 1] = new SourceGrid.Cells.CheckBox(null, true);
                                break;
                            }
                        }
                    }
                }
            }
            myRead.Close();
            DBConn.Close();
        }

        private void grid_bunryu_Click(object sender, EventArgs e)
        {
            GridHandle_bunryu.OnlyOneChk(1, grid_bunryu.Selection.ActivePosition.Row, 1);
            
        }

        private void grid_pgroup_Click(object sender, EventArgs e)
        {
            GridHandle_pgroup.OnlyOneChk(1, grid_pgroup.Selection.ActivePosition.Row, 1);
        }

        private void grid_pmake_Click(object sender, EventArgs e)
        {
            GridHandle_pmake.OnlyOneChk(1, grid_pmake.Selection.ActivePosition.Row, 1);
        }

        private void bModi_Click(object sender, EventArgs e)
        {
            cell_d cc = new cell_d();
            string weight = tbWeight.Text.Trim();
            string pname = tbPname.Text.Trim();
            string pcolor = tbColor.Text.Trim();
            string pthick = tbThick.Text.Trim();
            string notice_price = tbNoticePrice.Text.Trim().Replace(",", "");
            string bunryu = "";
            string bunryu_code = "";
            Get_item_n_code(ref bunryu, ref bunryu_code, grid_bunryu);

            string pgroup = "";
            string pgroup_code = "";
            Get_item_n_code(ref pgroup, ref pgroup_code, grid_pgroup);

            string pmake = "";
            string pmake_code = "";
            Get_item_n_code(ref pmake, ref pmake_code, grid_pmake);

            string sgroup = "";
            Get_item_package(ref sgroup, grid_sgroup);

            string ygroup = "";
            Get_item_package(ref ygroup, grid_ygroup);

            string Jang = "";
            if (rbJang_125.Checked == true)
                Jang = "125";
            else if (rbJang_250.Checked == true)
                Jang = "250";
            else if (rbJang_500.Checked == true)
                Jang = "500";
            else
                Jang = "null";

            string Sun = "";
            if (rbSun_110.Checked == true)
                Sun = "110";
            else if (rbSun_133.Checked == true)
                Sun = "133";
            else if (rbSun_175.Checked == true)
                Sun = "175";
            else
                Sun = "null";
            
            string puse = "";
            Get_item_package(ref puse, grid_puse);

            int jiup_num = 0;
            string jiup_code = "";
            for (int i = 1; i < grid_jiup.RowsCount; i++)
            {
                if (grid_jiup[i, 1].Value.Equals(true))
                {
                    jiup_num++;
                    jiup_code += grid_jiup[i, 4].ToString() + "#";
                }
            }

            if (review_data(pmake, sgroup, Jang, Sun, jiup_num) == false)
                return;

            string cQuery = "";
            cQuery = "update " + DB_TableName_paper + " set hang_class_code = '" + bunryu_code + "', hang_pgroup_code = '" + pgroup_code + "'";
            cQuery += ", hang_pmake_code = '" + pmake_code + "', paper_size_group = '" + sgroup + "', sock = " + Jang + "";
            cQuery += ", sunsu = " + Sun + ", hang_puse_group = '" + puse + "', paper_weight = '" + weight + "', paper_name = '" + pname + "'";
            cQuery += ", paper_color = '" + pcolor + "', paper_thick = '" + pthick + "', notice_price = '" + notice_price + "'";
            cQuery += ", yunjeon_size_group = '" + ygroup + "', supply_company_code = '" + jiup_code + "'";
            cQuery += " where row_id = '" + paper_id + "'";
            GridHandle_bunryu.DataUpdate(cQuery);  // 종이 내용에 대한것은 위 조건에서 끝. 지업사는 C_paper_hcust_manage에 update하면 됨.
            
            DataTable DT_server = new DataTable();
            MySqlConnection DBConn;

            DBConn = new MySqlConnection(Config.DB_con1);
            DBConn.Open();
            cQuery = "select * from " + DB_TableName_paper_manage + " where paper_id = '" + paper_id + "'";
            MySqlDataAdapter returnVal = new MySqlDataAdapter(cQuery, DBConn);
            returnVal.Fill(DT_server);
            returnVal.Dispose();
            DBConn.Close();

            DataRow[] dr;
            for (int i = 1; i < grid_jiup.RowsCount; i++)
            {
                if (grid_jiup[i, 1].Value.Equals(true))
                { 
                    dr = DT_server.Select("hcust_id = '"+grid_jiup[i, 0].ToString()+"'");
                    if (dr.Length != 0)
                    {
                        foreach (var row in dr)
                            row.Delete();
                    }
                    else
                    {
                        cQuery = "insert into " + DB_TableName_paper_manage + " (hcust_id, paper_id) values('" + grid_jiup[i, 0].ToString() + "', '" + paper_id + "')";
                        GridHandle_bunryu.DataUpdate(cQuery);
                        
                    }
                }
            }

            string where = " where row_id  = -1 ";
            for (int i = 0; i < DT_server.Rows.Count; i++)
            {
                if ( ! DT_server.Rows[i].RowState.Equals(DataRowState.Deleted) )
                {
                    where += " or row_id = '" + DT_server.Rows[i]["row_id"].ToString() + "' ";
                }
            }
            cQuery = "delete from " + DB_TableName_paper_manage + where;
            GridHandle_bunryu.DataUpdate(cQuery);
            last_id = true;
            this.Close();
        }

        private void Get_item_n_code(ref string item, ref string code, SourceGrid.Grid grid)
        {
            for (int i = 1; i < grid.RowsCount; i++)
            {
                if (grid[i, 1].Value.Equals(true))
                {
                    item = grid[i, 3].ToString();
                    code = grid[i, 4].ToString();
                }
            }
        }

        private void Get_item_package(ref string package, SourceGrid.Grid grid)
        {
            for (int i = 1; i < grid.RowsCount; i++)
            {
                if (grid[i, 1].Value.Equals(true))
                {
                    package += grid[i, 4].ToString();
                }

                if (grid.ColumnsCount > 6)  // 사이즈 그룹이면...
                {
                    if (grid[i, 7] != null)
                    {
                        if (grid[i, 7].Value.Equals(true))
                        {
                            package += grid[i, 10].ToString();
                        }
                    }
                }
            }
        }

        private void bAdd_Click(object sender, EventArgs e)
        {
            cell_d cc = new cell_d();
            ksgcontrol kc = new ksgcontrol();
            kc.ControlInit(Config.DB_con1, "", "", "");
            string weight = tbWeight.Text.Trim();
            string pname = tbPname.Text.Trim();
            string pcolor = tbColor.Text.Trim();
            string pthick = tbThick.Text.Trim();
            string notice_price = tbNoticePrice.Text.Trim().Replace(",","");
            string bunryu = "";
            string bunryu_code = "";
            Get_item_n_code(ref bunryu, ref bunryu_code, grid_bunryu);

            string pgroup = "";
            string pgroup_code = "";
            Get_item_n_code(ref pgroup, ref pgroup_code, grid_pgroup);

            string pmake = "";
            string pmake_code = "";
            Get_item_n_code(ref pmake, ref pmake_code, grid_pmake);

            string sgroup = "";
            Get_item_package(ref sgroup, grid_sgroup);

            string ygroup = "";
            Get_item_package(ref ygroup, grid_ygroup);

            string Jang = "";
            if (rbJang_125.Checked == true)
                Jang = "125";
            else if (rbJang_250.Checked == true)
                Jang = "250";
            else if (rbJang_500.Checked == true)
                Jang = "500";
            else
                Jang = "null";

            string Sun = "";
            if (rbSun_110.Checked == true)
                Sun = "110";
            else if (rbSun_133.Checked == true)
                Sun = "133";
            else if (rbSun_175.Checked == true)
                Sun = "175";
            else
                Sun = "null";

            string puse = "";
            Get_item_package(ref puse, grid_puse);

            int jiup_num = 0;
            string jiup_code = "";
            for (int i = 1; i < grid_jiup.RowsCount; i++)
            {
                if (grid_jiup[i, 1].Value.Equals(true))
                {
                    jiup_num++;
                    jiup_code += grid_jiup[i, 4].ToString() + "#";
                }
            }

            if (review_data(pmake, sgroup, Jang, Sun, jiup_num) == false)
                return;

            string cQuery = "";
            cQuery = "insert into " + DB_TableName_paper + " (hang_class_code, hang_pgroup_code, hang_pmake_code, paper_size_group,";
            cQuery += "sock, sunsu, hang_puse_group, paper_weight, paper_name, paper_color, paper_thick, notice_price, ton_su, yunjeon_size_group, supply_company_code) values(";
            cQuery += "'" + bunryu_code + "', '" + pgroup_code + "', '" + pmake_code + "', '" + sgroup + "', " + Jang + ", " + Sun + ", '" + puse + "', '" + weight + "'";
            cQuery += ", '" + pname + "', '" + pcolor + "', '" + pthick + "', '" + notice_price + "','0', '" + ygroup + "', '" + jiup_code + "')";
            string input_id = kc.DataUpdate(cQuery);  // 종이 내용에 대한것은 위 조건에서 끝. 지업사는 C_paper_hcust_manage에 update하면 됨.

            for (int i = 1; i < grid_jiup.RowsCount; i++)
            {
                if (grid_jiup[i, 1].Value.Equals(true))
                {
                    cQuery = "insert into " + DB_TableName_paper_manage + " (hcust_id, paper_id) values('" + grid_jiup[i, 0].ToString() + "', '" + input_id + "')";
                    GridHandle_bunryu.DataUpdate(cQuery);
                }
            }
            last_id = true;
            MessageBox.Show("추가하였습니다");
        }

        // 필수입력 자료 검증. 입력확인되면 true를, 데이터가 누락되어있으면 false 를 return
        public bool review_data(string pmake, string sgroup, string jang, string sunsu, int jiup_num)   
        {
            if (tbWeight.Text.Trim().Length <= 0)
            {
                MessageBox.Show("무게를 입력해 주세요");
                tbWeight.Focus();
                return false;
            }

            if (tbPname.Text.Trim().Length <= 0)
            {
                MessageBox.Show("종이명을 입력해 주세요");
                tbPname.Focus();
                return false;
            }

            //if (tbColor.Text.Trim().Length <= 0)
            //{
            //    MessageBox.Show("색상을 입력해 주세요");
            //    tbColor.Focus();
            //    return false;
            //}

            if (tbThick.Text.Trim().Length <= 0)
            {
                MessageBox.Show("두께를 입력해 주세요");
                tbThick.Focus();
                return false;
            }

            if (tbNoticePrice.Text.Trim().Length <= 0)
            {
                tbNoticePrice.Text = "0";
            }

            if (pmake.Length <= 0)
            {
                MessageBox.Show("제지사를 선택해 주세요");
                return false;
            }

            //if (sgroup.Length <= 0)
            //{
            //    MessageBox.Show("사이즈그룹을 선택해 주세요");
            //    return false;
            //}

            //if (jang.Length <= 0)
            //{
            //    MessageBox.Show("속(장)을 선택해 주세요");
            //    return false;
            //}

            //if (sunsu.Length <= 0)
            //{
            //    MessageBox.Show("선수를 선택해 주세요");
            //    return false;
            //}

            if (jiup_num <= 0)
            {
                MessageBox.Show("지업사를 선택해 주세요");
                return false;
            }

            return true;
        }

        private void grid_sgroup_MouseClick(object sender, MouseEventArgs e)
        {
            Rect ChkArea1 = new Rect();
            ChkArea1.Top = 0;
            ChkArea1.Left = 0;

            ChkArea1.Bottom = GridHandle_sgroup.grid.Rows[0].Height;
            ChkArea1.Right = 22;

            Rect ChkArea2 = new Rect();
            ChkArea2.Top = 0;
            ChkArea2.Left = grid_sgroup.Columns[1].Width + grid_sgroup.Columns[2].Width + grid_sgroup.Columns[3].Width;
            
            ChkArea2.Bottom = GridHandle_sgroup.grid.Rows[0].Height;
            ChkArea2.Right = ChkArea2.Left + 22;

            int m_x = e.X;
            int m_y = e.Y;

            if (m_x > ChkArea1.Left && m_x < ChkArea1.Right && m_y > ChkArea1.Top && m_y < ChkArea1.Bottom)  // chk 컬럼 클릭
            {
                if (Chk_sgroup_1 == false)
                {
                    Chk_sgroup_1 = true;
                    GridHandle_sgroup.ChkCheckAll(1);
                }
                else
                {
                    Chk_sgroup_1 = false;
                    GridHandle_sgroup.ChkCancel(1);
                }
            }
            else if (m_x > ChkArea2.Left && m_x < ChkArea2.Right && m_y > ChkArea2.Top && m_y < ChkArea2.Bottom)  // chk 컬럼 클릭
            {
                if (Chk_sgroup_2 == false)
                {
                    Chk_sgroup_2 = true;
                    GridHandle_sgroup.ChkCheckAll(7);
                }
                else
                {
                    Chk_sgroup_2 = false;
                    GridHandle_sgroup.ChkCancel(7);
                }
            }
        }

        private void grid_jiup_MouseClick(object sender, MouseEventArgs e)
        {
            Rect ChkArea1 = new Rect();
            ChkArea1.Top = 0;
            ChkArea1.Left = 0;

            ChkArea1.Bottom = GridHandle_jiup.grid.Rows[0].Height;
            ChkArea1.Right = 22;

            int m_x = e.X;
            int m_y = e.Y;

            if (m_x > ChkArea1.Left && m_x < ChkArea1.Right && m_y > ChkArea1.Top && m_y < ChkArea1.Bottom)  // chk 컬럼 클릭
            {
                if (Chk_jiup == false)
                {
                    Chk_jiup = true;
                    GridHandle_jiup.ChkCheckAll(1);
                }
                else
                {
                    Chk_jiup = false;
                    GridHandle_jiup.ChkCancel(1);
                }
            }
        }

        private void Form_502a_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.F10)
            {
                // NewItem = true;  // 추가이면 true, 수정이면 false
                if (NewItem)
                {
                    bAdd_Click(null, null);
                }
                else
                { 
                    bModi_Click(null, null);
                }
            }
            else if (e.KeyCode == Keys.Escape)
            {
                tbWeight.Focus();
            }
        }
    }
}
